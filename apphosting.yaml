# Settings for Backend (on Cloud Run).
# See https://firebase.google.com/docs/app-hosting/configure#cloud-run

# Custom run script for monorepo (keeps framework optimizations)
scripts:
  runCommand: sh -c "cd apps/webapp && pnpm start"

# Optimize runtime container by including only essential files
outputFiles:
  serverApp:
    include: [
      "apps/webapp/.next",        # Compiled Next.js build
      "apps/webapp/public",       # Static assets  
      "apps/webapp/package.json", # Runtime dependencies & scripts
      "apps/webapp/node_modules", # Symlinks to dependencies & workspace packages
      "node_modules",             # Root pnpm store with actual packages
      "packages/*/dist",          # Compiled workspace packages
      "packages/*/package.json",  # Package metadata for workspace packages
      "package.json",             # Root workspace config
      "pnpm-lock.yaml"            # Dependency resolution
    ]

runConfig:
  minInstances: 0
  # maxInstances: 100
  # concurrency: 80
  # cpu: 1
  # memoryMiB: 512

# Environment variables and secrets.
env:
  # Configure environment variables.
  # See https://firebase.google.com/docs/app-hosting/configure#user-defined-environment
  
  # Buildpack environment variables for build-time configuration
  - variable: GOOGLE_NODE_RUN_SCRIPTS
    value: build:webapp
    availability:
      - BUILD

  # Set NODE_ENV to production for optimized builds
  # Firebase App Hosting is purely for building deployable assets
  # Testing and linting are handled in separate CI pipeline (GitHub Actions)
  # so we don't need devDependencies during build/runtime
  - variable: NODE_ENV
    value: production
    availability:
      - BUILD
      - RUNTIME

  # Grant access to secrets in Cloud Secret Manager.
  # See https://firebase.google.com/docs/app-hosting/configure#secret-parameters
  # - variable: MY_SECRET
  #   secret: mySecretRef

  # Firebase Configuration (shared values - can be overridden in staging/prod files)
  - variable: NEXT_PUBLIC_FIREBASE_API_KEY
    value: AIzaSyC8BwpEonG8QVyOxqmVYQj7XU_2UoHvt_o
    availability:
      - BUILD
      - RUNTIME

  - variable: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
    value: decision-copilot.firebaseapp.com
    availability:
      - BUILD
      - RUNTIME

  - variable: NEXT_PUBLIC_FIREBASE_PROJECT_ID
    value: decision-copilot
    availability:
      - BUILD
      - RUNTIME

  - variable: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
    value: decision-copilot.firebasestorage.app
    availability:
      - BUILD
      - RUNTIME

  - variable: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
    value: "698337109435"
    availability:
      - BUILD
      - RUNTIME

  # Environment-specific values (overridden in staging/prod files)
  # NEXT_PUBLIC_FIREBASE_APP_ID
  # NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
